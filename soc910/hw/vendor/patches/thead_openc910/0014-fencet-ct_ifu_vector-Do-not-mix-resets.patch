From 4244c7dbd7e95384daf01c199de5ceeb02dca831 Mon Sep 17 00:00:00 2001
From: Nils Wistoff <nwistoff@iis.ee.ethz.ch>
Date: Fri, 17 Feb 2023 17:33:53 +0100
Subject: [PATCH] fencet/ct_ifu_vector: Do not mix resets

---
 C910_RTL_FACTORY/gen_rtl/ifu/rtl/ct_ifu_vector.v | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/C910_RTL_FACTORY/gen_rtl/ifu/rtl/ct_ifu_vector.v b/C910_RTL_FACTORY/gen_rtl/ifu/rtl/ct_ifu_vector.v
index 8a2e039..bf2b63a 100644
--- a/C910_RTL_FACTORY/gen_rtl/ifu/rtl/ct_ifu_vector.v
+++ b/C910_RTL_FACTORY/gen_rtl/ifu/rtl/ct_ifu_vector.v
@@ -127,6 +127,7 @@ parameter IDLE       = 11'b00000000001;
 //parameter EXP    = 11'b00010000000;
 parameter RESET       = 11'b00100000000;
 parameter PCLOAD      = 11'b01000000000;
+parameter PRE_RESET   = 11'b10000000000;
 parameter UARCH_RESET = 11'b10100000000;
 
 //---------------------Gate Clock---------------------------
@@ -174,7 +175,7 @@ begin
     // if(arch_rst_b) begin
     //   vec_cur_state[10:0] <= UARCH_RESET;
     // end
-    vec_cur_state[10:0] <= arch_rst_b ? UARCH_RESET : RESET;
+    vec_cur_state[10:0] <= PRE_RESET;
   end else if(rtu_ifu_xx_dbgon)
     vec_cur_state[10:0] <= IDLE;
   else
@@ -184,13 +185,15 @@ end
 // &CombBeg; @84
 always @( vec_cur_state[10:0]
        or cp0_ifu_rst_inv_done
-       or rtu_ifu_xx_expt_vld)
+       or rtu_ifu_xx_expt_vld
+       or arch_rst_b)
 begin
 case(vec_cur_state[10:0])
   IDLE    : if(rtu_ifu_xx_expt_vld)
               vec_next_state[10:0] = PCLOAD;
             else
               vec_next_state[10:0] = IDLE;
+  PRE_RESET : vec_next_state[10:0] = arch_rst_b ? UARCH_RESET : RESET;
   RESET, UARCH_RESET : if(cp0_ifu_rst_inv_done)
               vec_next_state[10:0] = IDLE;
             else
-- 
2.16.5

